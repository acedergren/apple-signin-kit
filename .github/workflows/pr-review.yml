name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: "pr-review-${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

jobs:
  # Request Copilot code review
  copilot-review:
    name: Request Copilot Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: ['copilot']
              });
              console.log('Copilot review requested successfully');
            } catch (error) {
              console.log('Note: Could not request Copilot review:', error.message);
            }

  # Claude Code security review using GitHub App
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          # Uses Claude GitHub App - no API key needed!
          # The app is installed and uses OAuth authentication
          use_oauth: true
          direct_prompt: |
            Review this PR for the Apple Sign-In Kit authentication library.

            Focus on:
            1. **Security** - PKCE (RFC 7636), JWT handling, token storage, timing attacks
            2. **Authentication** - Session management, account lockout (NIST 800-63B)
            3. **Code Quality** - TypeScript best practices, error handling
            4. **Breaking Changes** - API compatibility for consumers

            Format your review as:
            - ðŸ”´ **Critical** - Must fix (security/breaking)
            - ðŸŸ¡ **Warning** - Should address
            - ðŸŸ¢ **Approved** - Looks good
            - ðŸ’¡ **Suggestion** - Nice to have

  # Code quality checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        continue-on-error: true

      - name: Type check
        run: pnpm check
        continue-on-error: true

      - name: Lint
        run: pnpm lint
        continue-on-error: true
