name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: "pr-review-${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

jobs:
  # Request Copilot code review
  copilot-review:
    name: Request Copilot Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: ['copilot']
              });
              console.log('Copilot review requested successfully');
            } catch (error) {
              // Copilot may not be available, log and continue
              console.log('Note: Could not request Copilot review:', error.message);
              console.log('This is expected if Copilot is not enabled for this repository.');
            }

  # Security-focused review using Claude Code
  claude-security-review:
    name: Claude Security Review
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.labels.*.name, 'skip-security-review')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.ts
            **/*.js
            **/*.swift
            **/*.json
            **/*.yml
            **/*.yaml

      - name: Prepare review context
        id: context
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          # Get PR diff (limited to 50KB to avoid token limits)
          git diff origin/main...HEAD -- '*.ts' '*.js' '*.swift' | head -c 50000 > diff.txt

          # Count security-relevant changes
          SECURITY_FILES=$(echo "$ALL_CHANGED_FILES" | tr ' ' '\n' | grep -E "(auth|security|token|session|pkce|jwt)" | wc -l || echo "0")
          echo "security_files=$SECURITY_FILES" >> "$GITHUB_OUTPUT"

          # Check if this is a security-critical PR
          if [[ $SECURITY_FILES -gt 0 ]]; then
            echo "is_security_critical=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_security_critical=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Claude Security Analysis
        if: steps.context.outputs.is_security_critical == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          prompt: |
            You are a security-focused code reviewer for the Apple Sign-In Kit ecosystem.

            ## Context
            This is a PR for an Apple Sign-In authentication library. Key security concerns:
            - PKCE (RFC 7636) compliance
            - JWT validation and signing
            - Token storage and rotation
            - Account lockout (NIST 800-63B)
            - Timing attack prevention
            - Input validation

            ## Your Task
            Review the changes for:
            1. **Authentication vulnerabilities** - Token handling, session management
            2. **Cryptographic issues** - PKCE, JWT, hashing algorithms
            3. **Input validation** - Injection attacks, malformed data
            4. **Timing attacks** - Constant-time comparisons needed
            5. **Error handling** - Information leakage in errors

            ## Output Format
            Provide a concise review with:
            - ðŸ”´ **Critical** - Must fix before merge (security vulnerabilities)
            - ðŸŸ¡ **Warning** - Should address (potential issues)
            - ðŸŸ¢ **Good** - Security best practices followed
            - ðŸ’¡ **Suggestion** - Improvements (optional)

            If no security issues found, say "âœ… No security issues detected"

      - name: Comment on PR
        if: steps.context.outputs.is_security_critical == 'true'
        env:
          SECURITY_FILES: ${{ steps.context.outputs.security_files }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const securityFiles = process.env.SECURITY_FILES;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ðŸ”’ Security Review Triggered

            This PR modifies **${securityFiles}** security-related file(s).

            A Claude-powered security review has been requested. Please wait for the analysis to complete.

            <details>
            <summary>What's being checked?</summary>

            - PKCE implementation (RFC 7636)
            - JWT token handling
            - Session management security
            - Account lockout compliance (NIST 800-63B)
            - Timing attack prevention
            - Input validation

            </details>`
            });

  # Lint and type check for all PRs
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm check
        continue-on-error: true

      - name: Lint
        run: pnpm lint
        continue-on-error: true
